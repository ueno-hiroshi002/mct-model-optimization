
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>XQuant Extension Tool &#8212; MCT Documentation: ver 2.5.1</title>
    <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../static/bizstyle.css?v=5283bb3d" />
    <link rel="stylesheet" type="text/css" href="../static/css/custom.css?v=01243f34" />
    
    <script src="../static/documentation_options.js?v=983e91d6"></script>
    <script src="../static/doctools.js?v=9bcbadda"></script>
    <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Docs" href="../api/api_docs/index.html" />
    <link rel="prev" title="Visualization within TensorBoard" href="visualization.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../api/api_docs/index.html" title="API Docs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="visualization.html" title="Visualization within TensorBoard"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MCT Documentation: ver 2.5.1</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">XQuant Extension Tool</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="xquant-extension-tool">
<h1>XQuant Extension Tool<a class="headerlink" href="#xquant-extension-tool" title="Link to this heading">¶</a></h1>
<section id="about-xquant-extension-tool">
<h2>About XQuant Extension Tool<a class="headerlink" href="#about-xquant-extension-tool" title="Link to this heading">¶</a></h2>
<p>This tool calculates the quantization error for each layer by comparing outputs between the float and quantized models using the quantization log.
And, it identifies the causes of the detected errors and recommends appropriate improvement measures for each cause.
Finally, the results are presented in reports.</p>
<p>The following are the main components of this tool.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/api/api_docs/methods/xquant_report_troubleshoot_pytorch_experimental.html">XQuant Extension Tool</a></p></li>
</ul>
<blockquote>
<div><p>This tool detects degraded layers (layers with large quantization errors) and identifies the causes of degradation within those layers.</p>
</div></blockquote>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/index.html">Troubleshooting Manual</a></p></li>
</ul>
<blockquote>
<div><p>This document describes countermeasures for accuracy degradation based on causes identified by the XQuant Extension Tool.</p>
</div></blockquote>
</section>
<section id="overall-process-flow">
<h2>Overall Process Flow<a class="headerlink" href="#overall-process-flow" title="Link to this heading">¶</a></h2>
<img alt="../images/flow.png" src="../images/flow.png" />
<p>The overall process follows the steps below:</p>
<ol class="arabic simple">
<li><p>Input the float model, quantized model, and quantization log.</p></li>
<li><p>Detect layers that have large difference between float and quantized models.</p></li>
<li><p>Judge degradation causes on the detected layers.</p></li>
<li><p><strong>[Judgeable Troubleshoots]</strong> Based on the judge results, individual countermeasure procedures are suggested from the troubleshooting manual.</p></li>
<li><p><strong>[General Troubleshoots]</strong> When accuracy does not improve after steps 1-4, general improvement measures are suggested from the troubleshooting manual.</p></li>
</ol>
<p>Please refer to the <a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/index.html">Troubleshooting Manual</a> for the <strong>Judgeable Troubleshoots</strong> and <strong>General Troubleshoots</strong> in detail.</p>
</section>
<section id="how-to-run">
<h2>How to Run<a class="headerlink" href="#how-to-run" title="Link to this heading">¶</a></h2>
<p>This XQuant Extension Tool was created based on XQuant, as shown in the link below.
In addition to the conventional XQuant functions, it judges degradation causes and links to the Troubleshooting Manual that provides appropriate countermeasures for each cause of degradation.
It can suggest more specific countermeasures than conventional tools and provides manuals that are easy to understand even for users who are not familiar with quantization.</p>
<p>Please replace <em>xquant_report_pytorch_experimental</em> in <a class="reference external" href="https://github.com/SonySemiconductorSolutions/mct-model-optimization/tree/main/tutorials/notebooks/mct_features_notebooks/pytorch/example_pytorch_xquant.ipynb">the XQuant tutorial</a> with <em>xquant_report_troubleshoot_pytorch_experimental</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">model_compression_toolkit.xquant</span><span class="w"> </span><span class="kn">import</span> <span class="n">xquant_report_troubleshoot_pytorch_experimental</span>
<span class="c1"># xquant_report_pytorch_experimental --&gt; xquant_report_troubleshoot_pytorch_experimental</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">xquant_report_troubleshoot_pytorch_experimental</span><span class="p">(</span>
            <span class="n">float_model</span><span class="p">,</span>
            <span class="n">quantized_model</span><span class="p">,</span>
            <span class="n">random_data_gen</span><span class="p">,</span>
            <span class="n">validation_dataset</span><span class="p">,</span>
            <span class="n">xquant_config</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>To be more specific, execute the following steps:</p>
<ol class="arabic simple">
<li><p>Set log folder by <em>mct.set_log_folder</em></p></li>
<li><p>Do PTQ by <em>mct.ptq.pytorch_post_training_quantization</em></p></li>
<li><p>Define <em>XQuantConfig</em></p></li>
<li><p>Execute XQuant Extension Tool by <em>xquant_report_troubleshoot_pytorch_experimental</em></p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mct</span><span class="o">.</span><span class="n">set_log_folder</span><span class="p">(</span><span class="s1">&#39;./log/dir/path&#39;</span><span class="p">)</span>

<span class="n">quantized_model</span><span class="p">,</span> <span class="n">quantized_info</span> <span class="o">=</span> <span class="n">mct</span><span class="o">.</span><span class="n">ptq</span><span class="o">.</span><span class="n">pytorch_post_training_quantization</span><span class="p">(</span>
    <span class="n">in_module</span><span class="o">=</span><span class="n">float_model</span><span class="p">,</span> <span class="n">representative_data_gen</span><span class="o">=</span><span class="n">random_data_gen</span><span class="p">)</span>

<span class="n">xquant_config</span> <span class="o">=</span> <span class="n">XQuantConfig</span><span class="p">(</span><span class="n">report_dir</span><span class="o">=</span><span class="s1">&#39;./log_tensorboard_xquant&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">model_compression_toolkit.xquant</span><span class="w"> </span><span class="kn">import</span> <span class="n">xquant_report_troubleshoot_pytorch_experimental</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">xquant_report_troubleshoot_pytorch_experimental</span><span class="p">(</span>
            <span class="n">float_model</span><span class="p">,</span>
            <span class="n">quantized_model</span><span class="p">,</span>
            <span class="n">random_data_gen</span><span class="p">,</span>
            <span class="n">validation_dataset</span><span class="p">,</span>
            <span class="n">xquant_config</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If log of <em>mct.set_log_folder</em> does not exist, the <em>Unbalanced Concatenation</em> described below will not be executed.</p>
</div>
</section>
<section id="xquantconfig-format-and-examples">
<h2>XQuantConfig Format and Examples<a class="headerlink" href="#xquantconfig-format-and-examples" title="Link to this heading">¶</a></h2>
<p>When running XQuant Extension Tool, set the following parameters.</p>
<p>For other parameters, see <a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/api/api_docs/classes/XQuantConfig.html#ug-xquantconfig">API Document</a>.</p>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">XQuantConfig parameter</span><a class="headerlink" href="#id3" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 15.0%" />
<col style="width: 15.0%" />
<col style="width: 50.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>input parameter</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>details</p></th>
<th class="head"><p>initial value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>report_dir</p></td>
<td><p>str</p></td>
<td><p>Directory where the results will be saved. <strong>[Necessary]</strong></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">-</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>quantize_reported_dir</p></td>
<td><p>str</p></td>
<td><p>Directory where the the quantization log will be saved. If not specified, the path set with <em>mct.set_log_folder</em> will be used.</p></td>
<td><p>Most recently set value in <em>mct.set_log_folder</em></p></td>
</tr>
<tr class="row-even"><td><p>threshold_quantize_error</p></td>
<td><p>dict[str, float]</p></td>
<td><p>Threshold values for detecting degradation in accuracy.</p></td>
<td><p>{“mse”:0.1, “cs”:0.1, “sqnr”:0.1}</p></td>
</tr>
<tr class="row-odd"><td><p>threshold_degrade_layer_ratio</p></td>
<td><p>float</p></td>
<td><p>If the number of layers detected as degraded is large, skips the judge degradation causes specify the ratio here.</p></td>
<td><p>0.5</p></td>
</tr>
<tr class="row-even"><td><p>threshold_zscore_outlier_removal</p></td>
<td><p>float</p></td>
<td><p>Used in judgment degradation causes (Outlier Removal). Threshold for z_score to detect outliers.</p></td>
<td><p>5.0</p></td>
</tr>
<tr class="row-odd"><td><p>threshold_ratio_unbalanced_concatenation</p></td>
<td><p>float</p></td>
<td><p>Used in judgment degradation causes (unbalanced “concatenation”). Threshold for the multiplier of range width between concatenated layers.</p></td>
<td><p>16.0</p></td>
</tr>
<tr class="row-even"><td><p>threshold_bitwidth_mixed_precision
_with_model_output_loss_objective</p></td>
<td><p>int</p></td>
<td><p>Used in judgment degradation causes (Mixed precision with model output loss objective). Bitwidth of the final layer to judge insufficient bitwidth.</p></td>
<td><p>2</p></td>
</tr>
</tbody>
</table>
</section>
<section id="understanding-the-quantization-error-graph">
<h2>Understanding the Quantization Error Graph<a class="headerlink" href="#understanding-the-quantization-error-graph" title="Link to this heading">¶</a></h2>
<p>Six quantization error graphs are generated: three metrics (MSE, cosine similarity, SQNR) × two datasets (representative, validation).
Quantization error represents the differences of layer outputs between float and quantized models. These graphs are saved in the directory specified by the XQuantConfig’s report_dir.</p>
<p>Comparing each quantization error with <em>threshold_quantize_error</em> to identify layers with significant behavior changes after quantization.</p>
<p>As an example, an output graph calculated using “mse” with a representative dataset is shown.
The initial threshold value of 0.1 is set, and layers exceeding this threshold are indicated with a red circle. In addition, the corresponding layer names on the X axis are highlighted in red. With this graph, layers with accuracy degradation can be visually confirmed.</p>
<img alt="../images/quant_loss_mse_repr.png" src="../images/quant_loss_mse_repr.png" />
<ul class="simple">
<li><p><strong>X-axis</strong>: Layer names (layers identified as degraded are highlighted in red)</p></li>
<li><p><strong>Y-axis</strong>: Quantization error</p></li>
<li><p><strong>Red dashed line</strong>: Threshold for accuracy degradation as set in XQuantConfig</p></li>
<li><p><strong>Red circle</strong>: Layers judged to have degraded accuracy</p></li>
</ul>
</section>
<section id="understanding-the-judgeable-troubleshoots">
<h2>Understanding the Judgeable Troubleshoots<a class="headerlink" href="#understanding-the-judgeable-troubleshoots" title="Link to this heading">¶</a></h2>
<p>The following items are automatically identified by the XQuant Extension Tool.
When this tool detects these issues, corresponding WARNING messages are displayed in your console.
Please refer to the respective Troubleshooting Manuals and change the configuration as needed.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/troubleshoots/outlier_removal.html#ug-outlier-removal">Outlier Removal</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span><span class="n">Model</span> <span class="n">Compression</span> <span class="n">Toolkit</span><span class="p">:</span><span class="n">There</span> <span class="n">are</span> <span class="n">output</span> <span class="n">values</span> <span class="n">that</span> <span class="n">deviate</span> <span class="n">significantly</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">average</span><span class="o">.</span> <span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">following</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">TroubleShooting</span> <span class="n">Documentation</span> <span class="p">(</span><span class="n">MCT</span> <span class="n">XQuant</span> <span class="n">Extension</span> <span class="n">Tool</span><span class="p">)</span> <span class="n">of</span> <span class="s1">&#39;Outlier Removal&#39;</span><span class="o">.</span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/troubleshoots/shift_negative_activation.html#ug-shift-negative-activation">Shift Negative Activation</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span><span class="n">Model</span> <span class="n">Compression</span> <span class="n">Toolkit</span><span class="p">:</span><span class="n">There</span> <span class="n">are</span> <span class="n">activations</span> <span class="n">that</span> <span class="n">contain</span> <span class="n">negative</span> <span class="n">values</span><span class="o">.</span> <span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">troubleshooting</span> <span class="n">manual</span> <span class="n">of</span> <span class="s2">&quot;Shift Negative Activation&quot;</span><span class="o">.</span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/troubleshoots/unbalanced_concatenation.html#ug-unbalanced-concatenation">Unbalanced “concatenation”</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span><span class="n">Model</span> <span class="n">Compression</span> <span class="n">Toolkit</span><span class="p">:</span><span class="n">There</span> <span class="n">are</span> <span class="n">unbalanced</span> <span class="nb">range</span> <span class="n">layers</span> <span class="n">concatnated</span><span class="o">.</span> <span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">troubleshooting</span> <span class="n">manual</span> <span class="n">of</span> <span class="s1">&#39;Unbalanced &quot;concatenation&quot;&#39;</span><span class="o">.</span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/troubleshoots/mixed_precision_with_model_output_loss_objective.html#ug-mixed-precision-with-model-output-loss-objective">Mixed Precision with model output loss objective</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WARNING</span><span class="p">:</span><span class="n">Model</span> <span class="n">Compression</span> <span class="n">Toolkit</span><span class="p">:</span><span class="n">the</span> <span class="n">quantization</span> <span class="n">bitwidth</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">layer</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">extremely</span> <span class="n">small</span> <span class="n">number</span><span class="o">.</span> <span class="n">Refer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">troubleshooting</span> <span class="n">manual</span> <span class="n">of</span> <span class="s1">&#39;Mixed Precision with model output loss objective&#39;</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="understanding-the-general-troubleshoots">
<h2>Understanding the General Troubleshoots<a class="headerlink" href="#understanding-the-general-troubleshoots" title="Link to this heading">¶</a></h2>
<p>If no specific degradation causes are identified in the above judgment, or if accuracy does not improve after applying the proposed countermeasures, general improvement measures are suggested.</p>
<p>Please refer to the <strong>2. General Troubleshoots</strong> of <a class="reference external" href="https://sonysemiconductorsolutions.github.io/mct-model-optimization/docs_troubleshoot/index.html">Troubleshooting Manuals</a> for details.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">XQuant Extension Tool</a><ul>
<li><a class="reference internal" href="#about-xquant-extension-tool">About XQuant Extension Tool</a></li>
<li><a class="reference internal" href="#overall-process-flow">Overall Process Flow</a></li>
<li><a class="reference internal" href="#how-to-run">How to Run</a></li>
<li><a class="reference internal" href="#xquantconfig-format-and-examples">XQuantConfig Format and Examples</a></li>
<li><a class="reference internal" href="#understanding-the-quantization-error-graph">Understanding the Quantization Error Graph</a></li>
<li><a class="reference internal" href="#understanding-the-judgeable-troubleshoots">Understanding the Judgeable Troubleshoots</a></li>
<li><a class="reference internal" href="#understanding-the-general-troubleshoots">Understanding the General Troubleshoots</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="visualization.html"
                          title="previous chapter">Visualization within TensorBoard</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../api/api_docs/index.html"
                          title="next chapter">API Docs</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../api/api_docs/index.html" title="API Docs"
             >next</a> |</li>
        <li class="right" >
          <a href="visualization.html" title="Visualization within TensorBoard"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MCT Documentation: ver 2.5.1</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">XQuant Extension Tool</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, Sony Semiconductor Solutions.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>